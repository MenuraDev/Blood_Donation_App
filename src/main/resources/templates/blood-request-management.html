<!-- blood-request-management.html -->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blood Request Management - Blood Donation System</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
  </head>
  <body>
    <header>
      <div class="container">
        <div class="logo-container">
          <i class="fas fa-heartbeat"></i>
          <h1>Blood Donation Management</h1>
        </div>
        <nav>
          <ul>
            <li>
              <a href="/"><i class="fas fa-home"></i> Home</a>
            </li>
            <li>
              <a href="/login"><i class="fas fa-sign-in-alt"></i> Login</a>
            </li>
            <li>
              <a href="/register"><i class="fas fa-user-plus"></i> Sign Up</a>
            </li>
            <li>
              <a href="/donor-signup"
                ><i class="fas fa-tint"></i> Donor Sign Up</a
              >
            </li>
            <li>
              <a href="/dashboard"
                ><i class="fas fa-tachometer-alt"></i> Dashboard</a
              >
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <main>
      <div class="container">
        <div class="page-header">
          <h2>Blood Request Management</h2>
          <button id="addBloodRequestBtn" class="btn-primary">
            <i class="fas fa-plus-circle"></i> Add New Blood Request
          </button>
        </div>

        <!-- Blood Request List -->
        <div class="table-container">
          <h3>All Blood Requests</h3>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Blood Type</th>
                  <th>Quantity</th>
                  <th>Required Date</th>
                  <th>Status</th>
                  <th>Hospital Name</th>
                  <th class="actions-column">Actions</th>
                </tr>
              </thead>
              <tbody id="bloodRequestTableBody">
                <!-- Blood request rows will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- Blood Request Form Modal -->
    <div id="bloodRequestModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">Add New Blood Request</h3>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <form id="bloodRequestForm">
            <input type="hidden" id="requestId" name="requestId" />
            <input type="hidden" id="reqStatus" name="reqStatus" />
            <div class="form-group">
              <label for="bloodType">Blood Type</label>
              <select id="bloodType" name="bloodType" required>
                <option value="">Select Blood Type</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
              </select>
            </div>
            <div class="form-group">
              <label for="quantity">Quantity (units)</label>
              <input type="number" id="quantity" name="quantity" required min="1"/>
            </div>
            <div class="form-group">
              <label for="hospitalName">Hospital Name</label>
              <input type="text" id="hospitalName" name="hospitalName" required/>
            </div>
            <div class="form-group">
              <label for="reqDate">Required Date</label>
              <input type="date" id="reqDate" name="reqDate" required/>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-primary">Submit Request</button>
              <button type="button" class="btn-secondary" id="cancelEdit">
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
      <div class="modal-content success-content">
        <div class="modal-header">
          <h3>Success</h3>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <div class="notification success">
            <i class="fas fa-check-circle"></i>
            <p id="successMessage">Operation completed successfully!</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
      <div class="modal-content error-content">
        <div class="modal-header">
          <h3>Error</h3>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <div class="notification error">
            <i class="fas fa-exclamation-circle"></i>
            <p id="errorMessage">An error occurred!</p>
          </div>
        </div>
      </div>
    </div>
      </div>
    </main>

    <footer>
      <div class="container">
        <p>&copy; 2025 Blood Donation App. All rights reserved.</p>
      </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
      const API_BASE_URL = "/api/blood-requests";
      let currentUserRoles = [];
      let currentUserId = null;

      document.addEventListener("DOMContentLoaded", function () {
        const jwtToken = localStorage.getItem("jwtToken");
        if (!jwtToken) {
          window.location.href = "/login";
          return;
        }

        const rolesFromStorage = JSON.parse(
          localStorage.getItem("userRoles") || "[]"
        );
        if (rolesFromStorage.length > 0 && typeof rolesFromStorage[0] === "object") {
          currentUserRoles = rolesFromStorage.map((role) => role.authority);
        } else {
          currentUserRoles = rolesFromStorage;
        }

        currentUserId = localStorage.getItem("userId");

        loadBloodRequests();
        setupRoleBasedVisibility();

        // Modal event listeners
        document
          .getElementById("addBloodRequestBtn")
          .addEventListener("click", function () {
            openModal("bloodRequestModal");
            resetForm();
          });

        document
          .getElementById("bloodRequestForm")
          .addEventListener("submit", async function (event) {
            event.preventDefault();
            const requestId = document.getElementById("requestId").value;
            const formData = new FormData(this);
            const bloodRequest = {};

            for (let [key, value] of formData.entries()) {
              bloodRequest[key] = value;
            }

            if (requestId) {
              bloodRequest.requestId = parseInt(requestId, 10);
            } else {
              delete bloodRequest.requestId;
            }

            if (!requestId) {
              bloodRequest.reqStatus = "PENDING";
            } else {
              bloodRequest.reqStatus = document.getElementById("reqStatus").value;
            }

            if (hasRole("ROLE_HOSPITAL_COORDINATOR") && currentUserId) {
              bloodRequest.hospitalCoordinatorId = parseInt(currentUserId, 10);
            } else {
              delete bloodRequest.hospitalCoordinatorId;
            }

            if (requestId) {
              updateBloodRequest(requestId, bloodRequest);
            } else {
              createBloodRequest(bloodRequest);
            }
          });

        document
          .getElementById("cancelEdit")
          .addEventListener("click", function () {
            closeModal("bloodRequestModal");
            resetForm();
          });

        // Close modals when clicking on X
        document.querySelectorAll(".close").forEach((closeBtn) => {
          closeBtn.addEventListener("click", function () {
            const modalId = this.closest(".modal").id;
            closeModal(modalId);
          });
        });

        // Close modals when clicking outside
        window.addEventListener("click", function (event) {
          if (event.target.classList.contains("modal")) {
            closeModal(event.target.id);
          }
        });
      });

      function openModal(modalId) {
        document.getElementById(modalId).style.display = "block";
        document.body.style.overflow = "hidden";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
        document.body.style.overflow = "auto";
      }

      function hasRole(roleName) {
        return currentUserRoles.some(
          (role) =>
            (typeof role === "string" && role === roleName) ||
            (typeof role === "object" && role.authority === roleName)
        );
      }

      function setupRoleBasedVisibility() {
        const addBloodRequestBtn = document.getElementById("addBloodRequestBtn");
        if (hasRole("ROLE_HOSPITAL_COORDINATOR")) {
          addBloodRequestBtn.style.display = "inline-flex";
        } else {
          addBloodRequestBtn.style.display = "none";
        }
      }

      async function loadBloodRequests() {
        const tableBody = document.getElementById("bloodRequestTableBody");
        tableBody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';

        try {
          let url = API_BASE_URL;
          if (hasRole("ROLE_BLOOD_DONATION_MANAGER")) {
            url = API_BASE_URL;
          } else if (hasRole("ROLE_HOSPITAL_COORDINATOR")) {
            url = `${API_BASE_URL}/coordinator/${currentUserId}`;
          } else {
            tableBody.innerHTML =
              '<tr><td colspan="7">You do not have permission to view requests.</td></tr>';
            return;
          }

          const response = await fetch(url, {
            method: "GET",
            headers: {
              Authorization: "Bearer " + localStorage.getItem("jwtToken"),
            },
          });

          if (!response.ok) {
            let errorMessage = `Error: ${response.status} ${response.statusText}`;
            if (response.status === 403) {
              errorMessage =
                "Access Denied: You don't have the required permissions to view this data.";
            } else {
              try {
                const errorData = await response.json();
                errorMessage = errorData.message || JSON.stringify(errorData);
              } catch (e) {
                /* Response not JSON */
              }
            }
            throw new Error(errorMessage);
          }

          const requests = await response.json();

          tableBody.innerHTML = "";
          if (requests.length === 0) {
            tableBody.innerHTML =
              '<tr><td colspan="7">No blood requests found.</td></tr>';
            return;
          }

          requests.forEach((request) => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${request.requestId}</td>
                <td>${request.bloodType}</td>
                <td>${request.quantity}</td>
                <td>${formatDate(request.reqDate)}</td>
                <td>${request.reqStatus}</td>
                <td>${request.hospitalName || "N/A"}</td>
                <td class="actions-column">
                    ${
                      hasRole("ROLE_HOSPITAL_COORDINATOR")
                        ? `
                        <button class="btn-info edit-btn" data-id="${
                          request.requestId
                        }" data-request='${JSON.stringify(request)}'>
                          <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn-danger delete-btn" data-id="${
                          request.requestId
                        }">
                          <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    `
                        : ""
                    }
                    ${
                      hasRole("ROLE_BLOOD_DONATION_MANAGER") &&
                      request.reqStatus === "PENDING"
                        ? `
                        <button class="btn-success approve-btn" data-id="${
                          request.requestId
                        }">
                          <i class="fas fa-check-circle"></i> Approve
                        </button>
                        <button class="btn-warning disapprove-btn" data-id="${
                          request.requestId
                        }">
                          <i class="fas fa-times-circle"></i> Disapprove
                        </button>
                    `
                        : ""
                    }
                </td>
              `;
          });
          attachEventListeners();
        } catch (error) {
          tableBody.innerHTML = "";
          showErrorAlert(
            error.message ||
              "An unexpected error occurred while loading blood requests."
          );
          console.error("Error loading blood requests:", error);
        }
      }

      function attachEventListeners() {
        document.querySelectorAll(".edit-btn").forEach((button) => {
          button.removeEventListener("click", handleEditClick);
          button.addEventListener("click", handleEditClick);
        });

        document.querySelectorAll(".delete-btn").forEach((button) => {
          button.removeEventListener("click", handleDeleteClick);
          button.addEventListener("click", handleDeleteClick);
        });

        document.querySelectorAll(".approve-btn").forEach((button) => {
          button.removeEventListener("click", handleApproveClick);
          button.addEventListener("click", handleApproveClick);
        });

        document.querySelectorAll(".disapprove-btn").forEach((button) => {
          button.removeEventListener("click", handleDisapproveClick);
          button.addEventListener("click", handleDisapproveClick);
        });
      }

      function handleEditClick(event) {
        const request = JSON.parse(
          event.target.closest(".edit-btn").dataset.request
        );
        document.getElementById("requestId").value = request.requestId;
        document.getElementById("bloodType").value = request.bloodType;
        document.getElementById("quantity").value = request.quantity;
        document.getElementById("hospitalName").value = request.hospitalName;
        document.getElementById("reqDate").value = request.reqDate;
        document.getElementById("reqStatus").value = request.reqStatus;

        document.getElementById("modalTitle").textContent = "Edit Blood Request";
        document.querySelector(
          '#bloodRequestForm button[type="submit"]'
        ).textContent = "Update Request";
        openModal("bloodRequestModal");
      }

      function handleDeleteClick(event) {
        const id = event.target.closest(".delete-btn").dataset.id;
        deleteBloodRequest(id);
      }
      function handleApproveClick(event) {
        const id = event.target.closest(".approve-btn").dataset.id;
        approveBloodRequest(id);
      }
      function handleDisapproveClick(event) {
        const id = event.target.closest(".disapprove-btn").dataset.id;
        disapproveBloodRequest(id);
      }

      function resetForm() {
        document.getElementById("bloodRequestForm").reset();
        document.getElementById("requestId").value = "";
        document.getElementById("reqStatus").value = "";
        document.getElementById("modalTitle").textContent = "Add New Blood Request";
        document.querySelector(
          '#bloodRequestForm button[type="submit"]'
        ).textContent = "Submit Request";

      }

      async function createBloodRequest(bloodRequest) {
        try {
          const response = await fetch(API_BASE_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("jwtToken"),
            },
            body: JSON.stringify(bloodRequest),
          });

          if (response.ok) {
            closeModal("bloodRequestModal");
            showSuccessAlert("Blood request added successfully!");
            resetForm();
            loadBloodRequests();
          } else {
            let errorMessage = "Failed to add blood request.";
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
              const errorData = await response.json();
              errorMessage += " " + (errorData.message || response.statusText);
            } else {
              if (response.status === 403) {
                errorMessage +=
                  " You do not have permission to create blood requests. Please ensure you are logged in as a Hospital Coordinator.";
              } else {
                errorMessage +=
                  " Server responded with status: " +
                  response.status +
                  " " +
                  response.statusText;
              }
            }
            showErrorAlert(errorMessage);
          }
        } catch (error) {
          showErrorAlert(
            "An unexpected error occurred while adding blood request."
          );
          console.error("Error adding blood request:", error);
        }
      }

      async function updateBloodRequest(id, bloodRequest) {
        try {
          const response = await fetch(`${API_BASE_URL}/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("jwtToken"),
            },
            body: JSON.stringify(bloodRequest),
          });

          if (response.ok) {
            closeModal("bloodRequestModal");
            showSuccessAlert("Blood request updated successfully!");
            resetForm();
            loadBloodRequests();
          } else {
            const errorData = await response.json();
            showErrorAlert(
              "Failed to update blood request: " +
                (errorData.message || response.statusText)
            );
          }
        } catch (error) {
          showErrorAlert(
            "An unexpected error occurred while updating blood request."
          );
          console.error("Error updating blood request:", error);
        }
      }

      async function deleteBloodRequest(id) {
        if (confirm("Are you sure you want to delete this blood request?")) {
          try {
            const response = await fetch(`${API_BASE_URL}/${id}`, {
              method: "DELETE",
              headers: {
                Authorization: "Bearer " + localStorage.getItem("jwtToken"),
              },
            });

            if (response.ok) {
              showSuccessAlert("Blood request deleted successfully!");
              loadBloodRequests();
            } else {
              const errorData = await response.json();
              showErrorAlert(
                "Failed to delete blood request: " +
                  (errorData.message || response.statusText)
              );
            }
          } catch (error) {
            showErrorAlert(
              "An unexpected error occurred while deleting blood request."
            );
            console.error("Error deleting blood request:", error);
          }
        }
      }

      async function approveBloodRequest(id) {
        if (confirm("Are you sure you want to approve this blood request?")) {
          try {
            const response = await fetch(`${API_BASE_URL}/${id}/approve`, {
              method: "PUT",
              headers: {
                Authorization: "Bearer " + localStorage.getItem("jwtToken"),
              },
            });

            if (response.ok) {
              showSuccessAlert("Blood request approved successfully!");
              loadBloodRequests();
            } else {
              const errorData = await response.json();
              showErrorAlert(
                "Failed to approve blood request: " +
                  (errorData.message || response.statusText)
              );
            }
          } catch (error) {
            showErrorAlert(
              "An unexpected error occurred while approving blood request."
            );
            console.error("Error approving blood request:", error);
          }
        }
      }

      async function disapproveBloodRequest(id) {
        if (confirm("Are you sure you want to disapprove this blood request?")) {
          try {
            const response = await fetch(`${API_BASE_URL}/${id}/disapprove`, {
              method: "PUT",
              headers: {
                Authorization: "Bearer " + localStorage.getItem("jwtToken"),
              },
            });

            if (response.ok) {
              showSuccessAlert("Blood request disapproved successfully!");
              loadBloodRequests();
            } else {
              const errorData = await response.json();
              showErrorAlert(
                "Failed to disapprove blood request: " +
                  (errorData.message || response.statusText)
              );
            }
          } catch (error) {
            showErrorAlert(
              "An unexpected error occurred while disapproving blood request."
            );
            console.error("Error disapproving blood request:", error);
          }
        }
      }

      function showSuccessAlert(message) {
        document.getElementById("successMessage").textContent = message;
        openModal("successModal");
        setTimeout(() => {
          closeModal("successModal");
        }, 3000);
      }

      function showErrorAlert(message) {
        document.getElementById("errorMessage").textContent = message;
        openModal("errorModal");
        setTimeout(() => {
          closeModal("errorModal");
        }, 5000);
      }

      function formatDate(dateString) {
        const options = { year: "numeric", month: "long", day: "numeric" };
        return new Date(dateString).toLocaleDateString(undefined, options);
      }
    </script>
  </body>
</html>
