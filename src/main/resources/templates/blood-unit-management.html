<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blood Unit Management - Blood Donation System</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <style>
      .status-expired {
        color: #dc3545;
        font-weight: bold;
      }
      .status-valid {
        color: #28a745;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="logo-container">
          <i class="fas fa-heartbeat"></i>
          <h1>Blood Donation Management</h1>
        </div>
        <nav>
          <ul>
            <li><a href="/"><i class="fas fa-home"></i> Home</a></li>
            <li><a href="/login"><i class="fas fa-sign-in-alt"></i> Login</a></li>
            <li><a href="/register"><i class="fas fa-user-plus"></i> Sign Up</a></li>
            <li><a href="/donor-signup"><i class="fas fa-tint"></i> Donor Sign Up</a></li>
            <li><a href="/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main>
      <div class="container">
        <div class="page-header">
          <h2>Blood Unit Management</h2>
        </div>

        <div class="table-container">
          <h3>All Blood Units</h3>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th><th>Blood Type</th><th>Volume (ml)</th>
                  <th>Collection Date</th><th>Expiration Date</th><th>Status</th>
                  <th>Donation ID</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="bloodUnitTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
    
    <!-- Modals -->
    <div id="successModal" class="modal"><div class="modal-content notification-content"><div class="modal-body"><div class="notification success"><i class="fas fa-check-circle"></i><p id="successMessage"></p></div></div></div></div>
    <div id="errorModal" class="modal"><div class="modal-content notification-content"><div class="modal-body"><div class="notification error"><i class="fas fa-exclamation-circle"></i><p id="errorMessage"></p></div></div></div></div>

    <footer>
      <div class="container">
        <p>&copy; 2025 Blood Donation App. All rights reserved.</p>
      </div>
    </footer>

    <script>
      const API_BASE_URL = "/api/blood-units";
      let currentUserRoles = [];

      document.addEventListener("DOMContentLoaded", function () {
        const jwtToken = localStorage.getItem("jwtToken");
        if (!jwtToken) {
          window.location.href = "/login";
          return;
        }
        currentUserRoles = JSON.parse(localStorage.getItem("userRoles") || "[]");
        loadBloodUnits();
        
        window.addEventListener("click", e => { if (e.target.classList.contains("modal")) closeModal(e.target.id); });
        document.getElementById('bloodUnitTableBody').addEventListener('click', e => {
            const deleteBtn = e.target.closest('.delete-btn');
            if(deleteBtn) deleteBloodUnit(deleteBtn.dataset.id);
        });
      });

      function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
      function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
      function showSuccessAlert(message) { document.getElementById('successMessage').textContent = message; openModal('successModal'); setTimeout(() => closeModal('successModal'), 3000); }
      function showErrorAlert(message) { document.getElementById('errorMessage').textContent = message; openModal('errorModal'); setTimeout(() => closeModal('errorModal'), 5000); }

      function hasRole(roleName) { return currentUserRoles.includes(roleName); }
      
      async function fetchWithAuth(url, options = {}) {
        const headers = { 'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`, 'Content-Type': 'application/json', ...options.headers };
        const response = await fetch(url, { ...options, headers });
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: `HTTP error! Status: ${response.status}` }));
            throw new Error(errorData.message);
        }
        if (response.status === 204 || response.headers.get('content-length') === '0') return null;
        return response.json();
      }

      async function loadBloodUnits() {
        try {
          const units = await fetchWithAuth(API_BASE_URL);
          const tableBody = document.getElementById("bloodUnitTableBody");
          tableBody.innerHTML = "";
          const today = new Date();
          units.forEach((unit) => {
            const collectionDate = new Date(unit.collectedDate);
            const expirationDate = new Date(unit.expireDate);
            const isExpired = expirationDate < today;
            const status = isExpired ? "Expired" : "Not Expired";
            const statusClass = isExpired ? "status-expired" : "status-valid";

            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${unit.unitId}</td><td>${unit.bloodType.replace('_', ' ')}</td><td>${unit.volumeMl}</td>
                <td>${formatDate(collectionDate)}</td><td>${formatDate(expirationDate)}</td>
                <td class="${statusClass}">${status}</td><td>${unit.donation ? unit.donation.id : "N/A"}</td>
                <td class="actions-column">
                    ${hasRole("ROLE_BLOOD_DONATION_MANAGER") ? `<button class="btn-danger delete-btn" data-id="${unit.unitId}"><i class="fas fa-trash-alt"></i> Delete</button>` : ""}
                </td>`;
          });
        } catch (error) {
          showErrorAlert("Failed to load blood units: " + error.message);
        }
      }

      async function deleteBloodUnit(id) {
        if (confirm("Are you sure you want to delete this blood unit?")) {
          try {
            await fetchWithAuth(`${API_BASE_URL}/${id}`, { method: "DELETE" });
            showSuccessAlert("Blood unit deleted successfully!");
            loadBloodUnits();
          } catch (error) {
            showErrorAlert("Failed to delete blood unit: " + error.message);
          }
        }
      }
      
      function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString(undefined, { year: "numeric", month: "long", day: "numeric" });
      }
    </script>
  </body>
</html>