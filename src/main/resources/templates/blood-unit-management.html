<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
 <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Life Link - Home</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Koulen&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <style>
      .status-expired {
        color: #dc3545;
        font-weight: bold;
      }
      .status-valid {
        color: #28a745;
        font-weight: bold;
      }
      .btn-danger {
        background-color: #dc3545;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        margin: 0 4px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s ease;
      }
      .btn-danger:hover {
        background-color: #c82333;
      }
      .btn-info {
        background-color: #17a2b8;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        margin: 0 4px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s ease;
      }
      .btn-info:hover {
        background-color: #138496;
      }
      .btn-success {
        background-color: #28a745;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        margin: 0 4px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s ease;
      }
      .btn-success:hover {
        background-color: #218838;
      }
      .actions-column {
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="logo-container"> 
          <lottie-player class="logo-lottie" th:src="@{/img/heartlogo.json}" src="/img/heartlogo.json" renderer="svg" autoplay loop speed="1" aria-hidden="true"></lottie-player>
          <h1>Life Link</h1>
        </div>
        <input type="checkbox" id="nav-toggle" class="nav-toggle" />
        <label for="nav-toggle" class="nav-toggle-label">
          <span></span>
        </label>
        <nav class="nav">
          <ul>
            <li class="home-link">
              <a href="/">Home</a>
            </li>
            <li class="dashboard-link">
              <a href="/dashboard">Dashboard</a>
            </li>
            <li class="become-donor-link">
              <a href="/donor-signup">Become a Donor</a>
            </li>
            <li class="login-link">
              <a href="/login">Login</a>
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="dashboard-main">
      <div class="dashboard-container">
        <!-- Dashboard Header with Stats -->
        <div class="dashboard-header">
          <h2 class="dashboard-title">
            <i class="fas fa-tint"></i>
            Blood Unit Management
          </h2>
          <div class="dashboard-stats">
            <div class="stat-card">
              <div class="stat-icon blood-type">
                <i class="fas fa-tint"></i>
              </div>
              <div class="stat-info">
                <h4>Total Units</h4>
                <p class="stat-value" id="totalUnits">0</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon valid">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="stat-info">
                <h4>Valid Units</h4>
                <p class="stat-value" id="validUnits">0</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon expired">
                <i class="fas fa-exclamation-circle"></i>
              </div>
              <div class="stat-info">
                <h4>Expired Units</h4>
                <p class="stat-value" id="expiredUnits">0</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchUnits" placeholder="Search blood units...">
          </div>
        </div>

        <!-- Modern Table Container -->
        <div class="modern-table-container">
          <div class="table-responsive">
            <table class="modern-table">
              <thead>
                <tr>
                  <th>
                    <div class="th-content">
                      <span>ID</span>
                      <i class="fas fa-sort"></i>
                    </div>
                  </th>
                  <th>
                    <div class="th-content">
                      <span>Blood Type</span>
                      <i class="fas fa-sort"></i>
                    </div>
                  </th>
                  <th>
                    <div class="th-content">
                      <span>Volume (ml)</span>
                      <i class="fas fa-sort"></i>
                    </div>
                  </th>
                  <th>
                    <div class="th-content">
                      <span>Collection Date</span>
                      <i class="fas fa-sort"></i>
                    </div>
                  </th>
                  <th>
                    <div class="th-content">
                      <span>Expiration Date</span>
                      <i class="fas fa-sort"></i>
                    </div>
                  </th>
                  <th>
                    <div class="th-content">
                      <span>Status</span>
                      <i class="fas fa-sort"></i>
                    </div>
                  </th>
                  <th>
                    <div class="th-content">
                      <span>Donation ID</span>
                      <i class="fas fa-sort"></i>
                    </div>
                  </th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="bloodUnitTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
    
    <!-- Modals -->
    <div id="successModal" class="modal"><div class="modal-content notification-content"><div class="modal-body"><div class="notification success"><i class="fas fa-check-circle"></i><p id="successMessage"></p></div></div></div></div>
    <div id="errorModal" class="modal"><div class="modal-content notification-content"><div class="modal-body"><div class="notification error"><i class="fas fa-exclamation-circle"></i><p id="errorMessage"></p></div></div></div></div>

  

    <script>
      const API_BASE_URL = "/api/blood-units";
      let currentUserRoles = [];

      document.addEventListener("DOMContentLoaded", function () {
        const jwtToken = localStorage.getItem("jwtToken");
        if (!jwtToken) {
          window.location.href = "/login";
          return;
        }
        currentUserRoles = JSON.parse(localStorage.getItem("userRoles") || "[]");
        loadBloodUnits();
        
        window.addEventListener("click", e => { if (e.target.classList.contains("modal")) closeModal(e.target.id); });
        document.getElementById('bloodUnitTableBody').addEventListener('click', e => {
            const deleteBtn = e.target.closest('.delete-btn');
            if(deleteBtn) deleteBloodUnit(deleteBtn.dataset.id);
        });
      });

      function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
      function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
      function showSuccessAlert(message) { document.getElementById('successMessage').textContent = message; openModal('successModal'); setTimeout(() => closeModal('successModal'), 3000); }
      function showErrorAlert(message) { document.getElementById('errorMessage').textContent = message; openModal('errorModal'); setTimeout(() => closeModal('errorModal'), 5000); }

      function hasRole(roleName) { return currentUserRoles.includes(roleName); }
      
      async function fetchWithAuth(url, options = {}) {
        const headers = { 'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`, 'Content-Type': 'application/json', ...options.headers };
        const response = await fetch(url, { ...options, headers });
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: `HTTP error! Status: ${response.status}` }));
            throw new Error(errorData.message);
        }
        if (response.status === 204 || response.headers.get('content-length') === '0') return null;
        return response.json();
      }

      function setupSearchFunctionality() {
        const searchInput = document.getElementById("searchUnits");
        searchInput.addEventListener("input", function() {
          const searchTerm = this.value.toLowerCase();
          const rows = document.querySelectorAll("#bloodUnitTableBody tr");
          
          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? "" : "none";
          });
        });
      }

      function updateDashboardStats(units) {
        const today = new Date();
        const validUnits = units.filter(unit => new Date(unit.expireDate) >= today).length;
        const expiredUnits = units.filter(unit => new Date(unit.expireDate) < today).length;
        
        document.getElementById("totalUnits").textContent = units.length;
        document.getElementById("validUnits").textContent = validUnits;
        document.getElementById("expiredUnits").textContent = expiredUnits;
      }

      async function loadBloodUnits() {
        try {
          const units = await fetchWithAuth(API_BASE_URL);
          const tableBody = document.getElementById("bloodUnitTableBody");
          tableBody.innerHTML = "";
          const today = new Date();
          
          // Update dashboard stats
          const validUnits = units.filter(unit => new Date(unit.expireDate) >= today).length;
          const expiredUnits = units.filter(unit => new Date(unit.expireDate) < today).length;
          
          document.getElementById("totalUnits").textContent = units.length;
          document.getElementById("validUnits").textContent = validUnits;
          document.getElementById("expiredUnits").textContent = expiredUnits;

          // Setup search functionality
          setupSearchFunctionality();
          setupSearchFunctionality();
          units.forEach((unit) => {
            const collectionDate = new Date(unit.collectedDate);
            const expirationDate = new Date(unit.expireDate);
            const isExpired = expirationDate < today;
            const status = isExpired ? "Expired" : "Not Expired";
            const statusClass = isExpired ? "status-expired" : "status-valid";

            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${unit.unitId}</td><td>${unit.bloodType.replace('_', ' ')}</td><td>${unit.volumeMl}</td>
                <td>${formatDate(collectionDate)}</td><td>${formatDate(expirationDate)}</td>
                <td class="${statusClass}">${status}</td><td>${unit.donation ? unit.donation.id : "N/A"}</td>
                <td class="actions-column">
                    ${hasRole("ROLE_BLOOD_DONATION_MANAGER") ? `
                      <button class="btn-danger delete-btn" data-id="${unit.unitId}">
                        <i class="fas fa-trash-alt"></i> Delete
                      </button>` : ""}
                </td>`;
          });
        } catch (error) {
          showErrorAlert("Failed to load blood units: " + error.message);
        }
      }

      async function deleteBloodUnit(id) {
        if (confirm("Are you sure you want to delete this blood unit?")) {
          try {
            await fetchWithAuth(`${API_BASE_URL}/${id}`, { method: "DELETE" });
            showSuccessAlert("Blood unit deleted successfully!");
            loadBloodUnits();
          } catch (error) {
            showErrorAlert("Failed to delete blood unit: " + error.message);
          }
        }
      }
      
      function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString(undefined, { year: "numeric", month: "long", day: "numeric" });
      }
    </script>
  </body>
</html>