<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <link rel="stylesheet" href="../static/css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>Blood Donation Management</h1>
            <nav>
                <ul>
                    <li><a href="/">Home</a></li>
                    <li><a href="/login">Login</a></li>
                    <li><a href="/register">Sign Up</a></li>
                    <li><a href="/dashboard">Dashboard</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <h2 class="mb-4">User Management</h2>

            <div class="alert alert-success d-none" id="successAlert" role="alert"></div>
            <div class="alert alert-danger d-none" id="errorAlert" role="alert"></div>

            <!-- Add User Form -->
            <div class="form-container mb-4">
                <h3>Add New User</h3>
                <form id="addUserForm">
                    <div class="form-group">
                        <label for="firstName">First Name</label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>
                    <div class="form-group">
                        <label for="dob">Date of Birth</label>
                        <input type="date" id="dob" name="dob" required>
                    </div>
                    <div class="form-group">
                        <label for="age">Age</label>
                        <input type="number" id="age" name="age" readonly>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input type="text" id="phone" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender</label>
                        <select id="gender" name="gender" required>
                            <option value="">Select Gender</option>
                            <option value="MALE">Male</option>
                            <option value="FEMALE">Female</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="role">Role</label>
                        <select id="role" name="role" required>
                            <option value="">Select Role</option>
                            <option value="IT_OFFICER">IT Officer</option>
                            <option value="BLOOD_DONATION_MANAGER">Blood Donation Manager</option>
                            <option value="HOSPITAL_COORDINATOR">Hospital Coordinator</option>
                            <option value="NURSE">Nurse</option>
                            <option value="DONOR">Donor</option>
                            <option value="EVENT_ORGANIZER">Event Organizer</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">Add User</button>
                </form>
            </div>

            <!-- User List -->
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <!-- User rows will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Blood Donation App. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        const API_BASE_URL = '/api/users'; // Base URL for user API

        document.addEventListener('DOMContentLoaded', function() {
            const jwtToken = localStorage.getItem('jwtToken');
            if (!jwtToken) {
                window.location.href = '/login.html';
                return;
            }

            loadUsers();

            document.getElementById('dob').addEventListener('change', function() {
                const dob = new Date(this.value);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const m = today.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                document.getElementById('age').value = age;
            });

            document.getElementById('addUserForm').addEventListener('submit', async function(event) {
                event.preventDefault();
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (password !== confirmPassword) {
                    showErrorAlert('Passwords do not match.');
                    return;
                }

                const formData = new FormData(this);
                const newUser = {};
                for (let [key, value] of formData.entries()) {
                    if (key === 'dob') {
                        newUser[key] = value;
                    } else if (key === 'age') {
                        newUser[key] = parseInt(value);
                    } else {
                        newUser[key] = value;
                    }
                }
                addUser(newUser);
            });
        });

        async function loadUsers() {
            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                if (response.ok) {
                    const users = await response.json();
                    const userTableBody = document.getElementById('userTableBody');
                    userTableBody.innerHTML = '';
                    users.forEach(user => {
                        const row = userTableBody.insertRow();
                        row.innerHTML = `
                            <td>${user.userId}</td>
                            <td>${user.firstName}</td>
                            <td>${user.lastName}</td>
                            <td>${user.email}</td>
                            <td>${user.phone}</td>
                            <td>${user.role}</td>
                            <td>
                                <button class="btn-info edit-btn" data-id="${user.userId}" data-user='${JSON.stringify(user)}'>Edit</button>
                                <button class="btn-danger delete-btn" data-id="${user.userId}">Delete</button>
                            </td>
                        `;
                    });
                    attachEventListeners();
                } else {
                    const errorData = await response.json();
                    showErrorAlert('Failed to load users: ' + (errorData.message || response.statusText));
                }
            } catch (error) {
                showErrorAlert('An unexpected error occurred while loading users.');
                console.error('Error loading users:', error);
            }
        }

        async function addUser(user) {
            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    },
                    body: JSON.stringify(user)
                });

                if (response.ok) {
                    showSuccessAlert('User added successfully!');
                    document.getElementById('addUserForm').reset();
                    loadUsers();
                } else {
                    const errorData = await response.json();
                    showErrorAlert('Failed to add user: ' + (errorData.message || response.statusText));
                }
            } catch (error) {
                showErrorAlert('An unexpected error occurred while adding user.');
                console.error('Error adding user:', error);
            }
        }

        async function updateUser(id, user) {
            try {
                const response = await fetch(`${API_BASE_URL}/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    },
                    body: JSON.stringify(user)
                });

                if (response.ok) {
                    showSuccessAlert('User updated successfully!');
                    loadUsers();
                } else {
                    const errorData = await response.json();
                    showErrorAlert('Failed to update user: ' + (errorData.message || response.statusText));
                }
            } catch (error) {
                showErrorAlert('An unexpected error occurred while updating user.');
                console.error('Error updating user:', error);
            }
        }

        async function deleteUser(id) {
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                        }
                    });

                    if (response.ok) {
                        showSuccessAlert('User deleted successfully!');
                        loadUsers();
                    } else {
                        const errorData = await response.json();
                        showErrorAlert('Failed to delete user: ' + (errorData.message || response.statusText));
                    }
                } catch (error) {
                    showErrorAlert('An unexpected error occurred while deleting user.');
                    console.error('Error deleting user:', error);
                }
            }
        }

        function attachEventListeners() {
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.removeEventListener('click', handleEditClick); // Prevent multiple listeners
                button.addEventListener('click', handleEditClick);
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.removeEventListener('click', handleDeleteClick); // Prevent multiple listeners
                button.addEventListener('click', handleDeleteClick);
            });
        }

        function handleEditClick(event) {
            const id = event.target.dataset.id;
            const user = JSON.parse(event.target.dataset.user);

            const newFirstName = prompt('Enter new first name:', user.firstName);
            if (newFirstName === null) return;
            const newLastName = prompt('Enter new last name:', user.lastName);
            if (newLastName === null) return;
            const newDob = prompt('Enter new date of birth (YYYY-MM-DD):', user.dob);
            if (newDob === null) return;
            const newAge = prompt('Enter new age:', user.age);
            if (newAge === null) return;
            const newPhone = prompt('Enter new phone number:', user.phone);
            if (newPhone === null) return;
            const newEmail = prompt('Enter new email:', user.email);
            if (newEmail === null) return;
            const newGender = prompt('Enter new gender:', user.gender);
            if (newGender === null) return;
            const newPassword = prompt('Enter new password (leave blank to keep current):', '');

            const updatedUser = {
                firstName: newFirstName,
                lastName: newLastName,
                dob: newDob,
                age: parseInt(newAge),
                phone: newPhone,
                email: newEmail,
                gender: newGender,
                password: newPassword || undefined // Only send password if provided
            };

            updateUser(id, updatedUser);
        }

        function handleDeleteClick(event) {
            const id = event.target.dataset.id;
            deleteUser(id);
        }

        function showSuccessAlert(message) {
            const successAlert = document.getElementById('successAlert');
            successAlert.textContent = message;
            successAlert.classList.remove('d-none');
            successAlert.classList.add('show');
            setTimeout(() => {
                successAlert.classList.remove('show');
                successAlert.classList.add('d-none');
            }, 3000);
        }

        function showErrorAlert(message) {
            const errorAlert = document.getElementById('errorAlert');
            errorAlert.textContent = message;
            errorAlert.classList.remove('d-none');
            errorAlert.classList.add('show');
            setTimeout(() => {
                errorAlert.classList.remove('show');
                errorAlert.classList.add('d-none');
            }, 5000);
        }
    </script>
</body>
</html>
