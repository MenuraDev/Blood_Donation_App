<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
   <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Life Link - Home</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Koulen&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="logo-container"> 
          <lottie-player class="logo-lottie" th:src="@{/img/heartlogo.json}" src="/img/heartlogo.json" renderer="svg" autoplay loop speed="1" aria-hidden="true"></lottie-player>
          <h1>Life Link</h1>
        </div>
        <input type="checkbox" id="nav-toggle" class="nav-toggle" />
        <label for="nav-toggle" class="nav-toggle-label">
          <span></span>
        </label>
        <nav class="nav">
          <ul>
            <li class="home-link">
              <a href="/">Home</a>
            </li>
            <li class="dashboard-link">
              <a href="/dashboard">Dashboard</a>
            </li>
            <li class="become-donor-link">
              <a href="/donor-signup">Become a Donor</a>
            </li>
            <li class="login-link">
              <a href="/login">Login</a>
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="dashboard-main">
      <div class="dashboard-container">
        <!-- Dashboard Header with Stats -->
        <div class="dashboard-header">
          <h2 class="dashboard-title">
            <i class="fas fa-users"></i>
            User Management
          </h2>
          <div class="dashboard-stats">
            <div class="stat-card">
              <div class="stat-icon total">
                <i class="fas fa-users"></i>
              </div>
              <div class="stat-info">
                <h4>Total Users</h4>
                <p class="stat-value" id="totalUsers">0</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon active">
                <i class="fas fa-user-check"></i>
              </div>
              <div class="stat-info">
                <h4>Active Donors</h4>
                <p class="stat-value" id="activeDonors">0</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon staff">
                <i class="fas fa-user-tie"></i>
              </div>
              <div class="stat-info">
                <h4>Staff Members</h4>
                <p class="stat-value" id="staffMembers">0</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchUsers" placeholder="Search users...">
          </div>
          <button id="addUserBtn" class="btn-primary" style="display: none">
            <i class="fas fa-plus-circle"></i> Add New User
          </button>
        </div>

        <!-- Modern Table Container -->
        <div class="modern-table-container">
          <div class="table-responsive">
            <table class="modern-table">
              <thead>
                <tr>
                  <th><div class="th-content">
                      <span>ID</span>
                      <i class="fas fa-sort"></i>
                    </div></th>
                  <th><div class="th-content">
                      <span>First Name</span>
                      <i class="fas fa-sort"></i>
                    </div></th>
                  <th><div class="th-content">
                      <span>Last Name</span>
                      <i class="fas fa-sort"></i>
                    </div></th>
                  <th><div class="th-content">
                      <span>Email</span>
                      <i class="fas fa-sort"></i>
                    </div></th>
                  <th><div class="th-content">
                      <span>Phone</span>
                      <i class="fas fa-sort"></i>
                    </div></th>
                  <th><div class="th-content">
                      <span>Role</span>
                      <i class="fas fa-sort"></i>
                    </div></th>
                  <th class="actions-header" style="display: none">Actions</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <!-- User rows will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- User Form Modal -->
    <div id="userModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">Add New User</h3>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <form id="userForm">
            <input type="hidden" id="userId" name="userId" />
            <div class="form-group">
              <label for="firstName">First Name</label
              ><input type="text" id="firstName" name="firstName" required />
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label
              ><input type="text" id="lastName" name="lastName" required minlength="3" />
            </div>
            <div class="form-group">
              <label for="dob">Date of Birth</label
              ><input type="date" id="dob" name="dob" required />
            </div>
            <div class="form-group">
              <label for="age">Age</label
              ><input type="number" id="age" name="age" readonly />
            </div>
            <div class="form-group">
              <label for="nic">NIC</label
              ><input type="text" id="nic" name="nic" required minlength="10" />
            </div>
            <div class="form-group">
              <label for="phone">Phone Number</label
              ><input type="text" id="phone" name="phone" required />
            </div>
            <div class="form-group">
              <label for="email">Email</label
              ><input type="email" id="email" name="email" required />
            </div>
            <div class="form-group">
              <label for="gender">Gender</label>
              <select id="gender" name="gender" required>
                <option value="">Select Gender</option>
                <option value="MALE">Male</option>
                <option value="FEMALE">Female</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label for="role">Role</label>
              <select id="role" name="role" required>
                <option value="">Select Role</option>
                <option value="IT_OFFICER">IT Officer</option>
                <option value="BLOOD_DONATION_MANAGER">
                  Blood Donation Manager
                </option>
                <option value="HOSPITAL_COORDINATOR">
                  Hospital Coordinator
                </option>
                <option value="NURSE">Nurse</option>
                <option value="DONOR">Donor</option>
                <option value="EVENT_ORGANIZER">Event Organizer</option>
              </select>
            </div>
            <div class="form-group">
              <label for="password" required>Password</label>
                <input
                type="password"
                id="password"
                name="password"
                minlength="6"
              />
            </div>
            <div class="form-group">
              <label for="passwordConfirm">Confirm Password</label
              ><input
                type="password"
                id="passwordConfirm"
                name="passwordConfirm"
              />
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-primary">Submit</button>
              <button type="button" class="btn-secondary" id="cancelBtn">
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
      <div class="modal-content notification-content">
        <div class="modal-body">
          <div class="notification success">
            <i class="fas fa-check-circle"></i>
            <p id="successMessage">Operation completed successfully!</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
      <div class="modal-content notification-content">
        <div class="modal-body">
          <div class="notification error">
            <i class="fas fa-exclamation-circle"></i>
            <p id="errorMessage">An error occurred!</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 
    <footer>
      <div class="container">
        <p>&copy; 2025 Life Link. All rights reserved.</p>
      </div>
    </footer>
    -->

    <script>
      const API_BASE_URL = "/api/users";
      let currentUserRoles = [];

      document.addEventListener("DOMContentLoaded", function () {
        const jwtToken = localStorage.getItem("jwtToken");
        if (!jwtToken) {
          window.location.href = "/login";
          return;
        }

        try {
          currentUserRoles = JSON.parse(
            localStorage.getItem("userRoles") || "[]"
          );
        } catch (e) {
          console.error("Could not parse user roles from localStorage", e);
          currentUserRoles = [];
        }

        setupEventListeners();
        loadUsers();
        setupRoleBasedVisibility();
      });

      function openModal(modalId) {
        document.getElementById(modalId).style.display = "flex";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      function setupEventListeners() {
        document.getElementById("dob").addEventListener("change", function () {
          if (this.value) {
            const dob = new Date(this.value);
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
              age--;
            }
            document.getElementById("age").value = age;
          }
        });

        document.getElementById("addUserBtn").addEventListener("click", () => {
          document.getElementById("userForm").reset();
          document.getElementById("userId").value = "";
          document.getElementById("modalTitle").textContent = "Add New User";
          document.querySelector(
            '#userForm button[type="submit"]'
          ).textContent = "Add User";
          document
            .getElementById("password")
            .setAttribute("required", "required");
          document
            .getElementById("passwordConfirm")
            .setAttribute("required", "required");
          openModal("userModal");
        });

        document
          .getElementById("userForm")
          .addEventListener("submit", async function (event) {
            event.preventDefault();
            const password = document.getElementById("password").value;
            const passwordConfirm =
              document.getElementById("passwordConfirm").value;

            if (password !== passwordConfirm) {
              showErrorAlert("Passwords do not match.");
              return;
            }

            const formData = new FormData(this);
            const user = {};
            formData.forEach((value, key) => {
              if (value) user[key] = value;
            });

            if (user.age) user.age = parseInt(user.age, 10);
            if (user.userId) user.userId = parseInt(user.userId, 10);

            if (user.userId) {
              updateUser(user.userId, user);
            } else {
              addUser(user);
            }
          });

        document
          .getElementById("userTableBody")
          .addEventListener("click", function (event) {
            const editBtn = event.target.closest(".edit-btn");
            const deleteBtn = event.target.closest(".delete-btn");
            if (editBtn) {
              handleEditClick(editBtn);
            } else if (deleteBtn) {
              handleDeleteClick(deleteBtn);
            }
          });

        document
          .getElementById("cancelBtn")
          .addEventListener("click", () => closeModal("userModal"));
        document
          .querySelector("#userModal .close")
          .addEventListener("click", () => closeModal("userModal"));
      }

      async function fetchWithAuth(url, options = {}) {
        const jwtToken = localStorage.getItem("jwtToken");
        const headers = {
          Authorization: `Bearer ${jwtToken}`,
          "Content-Type": "application/json",
          ...options.headers,
        };
        const response = await fetch(url, { ...options, headers });
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({
            message: `HTTP error! Status: ${response.status}`,
          }));
          throw new Error(errorData.message);
        }
        // For DELETE requests with no content
        if (
          response.status === 204 ||
          response.headers.get("content-length") === "0"
        ) {
          return null;
        }
        return response.json();
      }

      async function loadUsers() {
        try {
          const users = await fetchWithAuth(API_BASE_URL);
          const userTableBody = document.getElementById("userTableBody");
          userTableBody.innerHTML = "";

          // Update dashboard stats
          const totalUsers = users.length;
          const activeDonors = users.filter(user => user.role === 'DONOR').length;
          const staffMembers = users.filter(user => user.role !== 'DONOR').length;

          document.getElementById("totalUsers").textContent = totalUsers;
          document.getElementById("activeDonors").textContent = activeDonors;
          document.getElementById("staffMembers").textContent = staffMembers;

          // Add search functionality
          setupSearchFunctionality();

          users.forEach((user) => {
            const row = userTableBody.insertRow();
            const userJsonString = JSON.stringify(user).replace(/'/g, "&apos;");
            row.innerHTML = `
                        <td>${user.userId}</td>
                        <td>${user.firstName}</td>
                        <td>${user.lastName}</td>
                        <td>${user.email}</td>
                        <td>${user.phone}</td>
                        <td>${user.role}</td>
                        <td class="actions-column" style="display: none;"><button class="btn-info edit-btn" data-id="${user.userId}" 
                          data-user='${JSON.stringify(user)}'
                          style="padding: 8px 16px; border-radius: 999px; border: none; background-color: #17a2b8; color: white; cursor: pointer; margin: 0 4px; display: inline-flex; align-items: center; gap: 8px;">
                          <i class="fas fa-edit"></i> Edit
                        </button>
                      <button class="btn-danger delete-btn" data-id="${user.userId}"
                          style="padding: 8px 16px; border-radius: 999px; border: none; background-color: #dc3545; color: white; cursor: pointer; margin: 0 4px; display: inline-flex; align-items: center; gap: 8px;">
                          <i class="fas fa-trash-alt"></i> Delete
                      </button>
                        </td>
                    `;
          });
          setupRoleBasedVisibility();
        } catch (error) {
          showErrorAlert(`Failed to load users: ${error.message}`);
        }
      }

      async function addUser(user) {
        try {
          const responseData = await fetchWithAuth("/api/auth/signup", {
            method: "POST",
            body: JSON.stringify(user),
          });
          closeModal("userModal");
          showSuccessAlert(responseData.message || "User added successfully!");
          loadUsers();
        } catch (error) {
          showErrorAlert(`Failed to add user: ${error.message}`);
        }
      }

      async function updateUser(id, user) {
        try {
          await fetchWithAuth(`${API_BASE_URL}/${id}`, {
            method: "PUT",
            body: JSON.stringify(user),
          });
          closeModal("userModal");
          showSuccessAlert("User updated successfully!");
          loadUsers();
        } catch (error) {
          showErrorAlert(`Failed to update user: ${error.message}`);
        }
      }

      async function deleteUser(id) {
        if (confirm("Are you sure you want to delete this user?")) {
          try {
            await fetchWithAuth(`${API_BASE_URL}/${id}`, { method: "DELETE" });
            showSuccessAlert("User deleted successfully!");
            loadUsers();
          } catch (error) {
            showErrorAlert(`Failed to delete user: ${error.message}`);
          }
        }
      }

      function setupRoleBasedVisibility() {
        const canManage =
          currentUserRoles.includes("ROLE_IT_OFFICER") ||
          currentUserRoles.includes("ROLE_BLOOD_DONATION_MANAGER");
        const displayStyle = canManage ? "inline-flex" : "none";
        const tableCellStyle = canManage ? "flex" : "none";

        document.getElementById("addUserBtn").style.display = displayStyle;
        document.querySelector(".actions-header").style.display = canManage
          ? "table-cell"
          : "none";
        document.querySelectorAll(".actions-column").forEach((col) => {
          col.style.display = tableCellStyle;
        });
      }

      function handleEditClick(button) {
        const user = JSON.parse(button.dataset.user);

        document.getElementById("userId").value = user.userId;
        document.getElementById("firstName").value = user.firstName;
        document.getElementById("lastName").value = user.lastName;
        document.getElementById("dob").value = user.dob;
        document.getElementById("age").value = user.age;
        document.getElementById("nic").value = user.nic;
        document.getElementById("phone").value = user.phone;
        document.getElementById("email").value = user.email;
        document.getElementById("gender").value = user.gender;
        document.getElementById("role").value = user.role;
        document.getElementById("password").value = "";
        document.getElementById("passwordConfirm").value = "";

        document.getElementById("password").removeAttribute("required");
        document.getElementById("passwordConfirm").removeAttribute("required");

        document.getElementById("modalTitle").textContent = "Edit User";
        document.querySelector('#userForm button[type="submit"]').textContent =
          "Update User";
        openModal("userModal");
      }

      function handleDeleteClick(button) {
        const id = button.dataset.id;
        deleteUser(id);
      }

      function setupSearchFunctionality() {
        const searchInput = document.getElementById("searchUsers");
        searchInput.addEventListener("input", function() {
          const searchTerm = this.value.toLowerCase();
          const rows = document.querySelectorAll("#userTableBody tr");
          
          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? "" : "none";
          });
        });
      }

      function showSuccessAlert(message) {
        document.getElementById("successMessage").textContent = message;
        openModal("successModal");
        setTimeout(() => closeModal("successModal"), 3000);
      }

      function showErrorAlert(message) {
        document.getElementById("errorMessage").textContent = message;
        openModal("errorModal");
        setTimeout(() => closeModal("errorModal"), 5000);
      }
    </script>
  </body>
</html>
