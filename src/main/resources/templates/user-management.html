<<<<<<< Updated upstream
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <link rel="stylesheet" href="../static/css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>Blood Donation Management</h1>
            <nav>
                <ul>
                    <li><a href="/">Home</a></li>
                    <li><a href="/login">Login</a></li>
                    <li><a href="/register">Sign Up</a></li>
                    <li><a href="/dashboard">Dashboard</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <h2 class="mb-4">User Management</h2>

            <div class="alert alert-success d-none" id="successAlert" role="alert"></div>
            <div class="alert alert-danger d-none" id="errorAlert" role="alert"></div>

            <!-- Add User Form -->
            <div class="form-container mb-4">
                <h3>Add New User</h3>
                <form id="addUserForm">
                    <div class="form-group">
                        <label for="firstName">First Name</label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>
                    <div class="form-group">
                        <label for="dob">Date of Birth</label>
                        <input type="date" id="dob" name="dob" required>
                    </div>
                    <div class="form-group">
                        <label for="age">Age</label>
                        <input type="number" id="age" name="age" readonly>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input type="text" id="phone" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender</label>
                        <select id="gender" name="gender" required>
                            <option value="">Select Gender</option>
                            <option value="MALE">Male</option>
                            <option value="FEMALE">Female</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="role">Role</label>
                        <select id="role" name="role" required>
                            <option value="">Select Role</option>
                            <option value="IT_OFFICER">IT Officer</option>
                            <option value="BLOOD_DONATION_MANAGER">Blood Donation Manager</option>
                            <option value="HOSPITAL_COORDINATOR">Hospital Coordinator</option>
                            <option value="NURSE">Nurse</option>
                            <option value="DONOR">Donor</option>
                            <option value="EVENT_ORGANIZER">Event Organizer</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">Add User</button>
                </form>
            </div>

            <!-- User List -->
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <!-- User rows will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Blood Donation App. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        const API_BASE_URL = '/api/users'; // Base URL for user API

        document.addEventListener('DOMContentLoaded', function() {
            const jwtToken = localStorage.getItem('jwtToken');
            if (!jwtToken) {
                window.location.href = '/login.html';
                return;
            }

            loadUsers();

            document.getElementById('dob').addEventListener('change', function() {
                const dob = new Date(this.value);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const m = today.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                document.getElementById('age').value = age;
            });

            document.getElementById('addUserForm').addEventListener('submit', async function(event) {
                event.preventDefault();
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (password !== confirmPassword) {
                    showErrorAlert('Passwords do not match.');
                    return;
                }

                const formData = new FormData(this);
                const newUser = {};
                for (let [key, value] of formData.entries()) {
                    if (key === 'dob') {
                        newUser[key] = value;
                    } else if (key === 'age') {
                        newUser[key] = parseInt(value);
                    } else {
                        newUser[key] = value;
                    }
                }
                addUser(newUser);
            });
        });

        async function loadUsers() {
            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                if (response.ok) {
                    const users = await response.json();
                    const userTableBody = document.getElementById('userTableBody');
                    userTableBody.innerHTML = '';
                    users.forEach(user => {
                        const row = userTableBody.insertRow();
                        row.innerHTML = `
                            <td>${user.userId}</td>
                            <td>${user.firstName}</td>
                            <td>${user.lastName}</td>
                            <td>${user.email}</td>
                            <td>${user.phone}</td>
                            <td>${user.role}</td>
                            <td>
                                <button class="btn-info edit-btn" data-id="${user.userId}" data-user='${JSON.stringify(user)}'>Edit</button>
                                <button class="btn-danger delete-btn" data-id="${user.userId}">Delete</button>
                            </td>
                        `;
                    });
                    attachEventListeners();
                } else {
                    const errorData = await response.json();
                    showErrorAlert('Failed to load users: ' + (errorData.message || response.statusText));
                }
            } catch (error) {
                showErrorAlert('An unexpected error occurred while loading users.');
                console.error('Error loading users:', error);
            }
        }

        async function addUser(user) {
            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    },
                    body: JSON.stringify(user)
                });

                if (response.ok) {
                    showSuccessAlert('User added successfully!');
                    document.getElementById('addUserForm').reset();
                    loadUsers();
                } else {
                    const errorData = await response.json();
                    showErrorAlert('Failed to add user: ' + (errorData.message || response.statusText));
                }
            } catch (error) {
                showErrorAlert('An unexpected error occurred while adding user.');
                console.error('Error adding user:', error);
            }
        }

        async function updateUser(id, user) {
            try {
                const response = await fetch(`${API_BASE_URL}/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    },
                    body: JSON.stringify(user)
                });

                if (response.ok) {
                    showSuccessAlert('User updated successfully!');
                    loadUsers();
                } else {
                    const errorData = await response.json();
                    showErrorAlert('Failed to update user: ' + (errorData.message || response.statusText));
                }
            } catch (error) {
                showErrorAlert('An unexpected error occurred while updating user.');
                console.error('Error updating user:', error);
            }
        }

        async function deleteUser(id) {
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                        }
                    });

                    if (response.ok) {
                        showSuccessAlert('User deleted successfully!');
                        loadUsers();
                    } else {
                        const errorData = await response.json();
                        showErrorAlert('Failed to delete user: ' + (errorData.message || response.statusText));
                    }
                } catch (error) {
                    showErrorAlert('An unexpected error occurred while deleting user.');
                    console.error('Error deleting user:', error);
                }
            }
        }

        function attachEventListeners() {
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.removeEventListener('click', handleEditClick); // Prevent multiple listeners
                button.addEventListener('click', handleEditClick);
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.removeEventListener('click', handleDeleteClick); // Prevent multiple listeners
                button.addEventListener('click', handleDeleteClick);
            });
        }

        function handleEditClick(event) {
            const id = event.target.dataset.id;
            const user = JSON.parse(event.target.dataset.user);

            const newFirstName = prompt('Enter new first name:', user.firstName);
            if (newFirstName === null) return;
            const newLastName = prompt('Enter new last name:', user.lastName);
            if (newLastName === null) return;
            const newDob = prompt('Enter new date of birth (YYYY-MM-DD):', user.dob);
            if (newDob === null) return;
            const newAge = prompt('Enter new age:', user.age);
            if (newAge === null) return;
            const newPhone = prompt('Enter new phone number:', user.phone);
            if (newPhone === null) return;
            const newEmail = prompt('Enter new email:', user.email);
            if (newEmail === null) return;
            const newGender = prompt('Enter new gender:', user.gender);
            if (newGender === null) return;
            const newPassword = prompt('Enter new password (leave blank to keep current):', '');

            const updatedUser = {
                firstName: newFirstName,
                lastName: newLastName,
                dob: newDob,
                age: parseInt(newAge),
                phone: newPhone,
                email: newEmail,
                gender: newGender,
                password: newPassword || undefined // Only send password if provided
            };

            updateUser(id, updatedUser);
        }

        function handleDeleteClick(event) {
            const id = event.target.dataset.id;
            deleteUser(id);
        }

        function showSuccessAlert(message) {
            const successAlert = document.getElementById('successAlert');
            successAlert.textContent = message;
            successAlert.classList.remove('d-none');
            successAlert.classList.add('show');
            setTimeout(() => {
                successAlert.classList.remove('show');
                successAlert.classList.add('d-none');
            }, 3000);
        }

        function showErrorAlert(message) {
            const errorAlert = document.getElementById('errorAlert');
            errorAlert.textContent = message;
            errorAlert.classList.remove('d-none');
            errorAlert.classList.add('show');
            setTimeout(() => {
                errorAlert.classList.remove('show');
                errorAlert.classList.add('d-none');
            }, 5000);
        }
    </script>
</body>
</html>
=======
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Management</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
  </head>
  <body>
    <header>
      <div class="container">
        <div class="logo-container">
          <i class="fas fa-heartbeat"></i>
          <h1>Blood Donation Management</h1>
        </div>
        <nav>
          <ul>
            <li>
              <a href="/"><i class="fas fa-home"></i> Home</a>
            </li>
            <li>
              <a href="/login"><i class="fas fa-sign-in-alt"></i> Login</a>
            </li>
            <li>
              <a href="/register"><i class="fas fa-user-plus"></i> Sign Up</a>
            </li>
            <li>
              <a href="/donor-signup"
                ><i class="fas fa-tint"></i> Donor Sign Up</a
              >
            </li>
            <li>
              <a href="/dashboard"
                ><i class="fas fa-tachometer-alt"></i> Dashboard</a
              >
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <main>
      <div class="container">
        <div class="page-header">
          <h2>User Management</h2>
          <button id="addUserBtn" class="btn-primary" style="display: none">
            <i class="fas fa-plus-circle"></i> Add New User
          </button>
        </div>

        <!-- User List -->
        <div class="table-container">
          <h3>All Users</h3>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Role</th>
                  <th class="actions-header" style="display: none">Actions</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <!-- User rows will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- User Form Modal -->
    <div id="userModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">Add New User</h3>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <form id="userForm">
            <input type="hidden" id="userId" name="userId" />
            <div class="form-group">
              <label for="firstName">First Name</label
              ><input type="text" id="firstName" name="firstName" required />
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label
              ><input type="text" id="lastName" name="lastName" required minlength="3" />
            </div>
            <div class="form-group">
              <label for="dob">Date of Birth</label
              ><input type="date" id="dob" name="dob" required />
            </div>
            <div class="form-group">
              <label for="age">Age</label
              ><input type="number" id="age" name="age" readonly />
            </div>
            <div class="form-group">
              <label for="nic">NIC</label
              ><input type="text" id="nic" name="nic" required minlength="10" />
            </div>
            <div class="form-group">
              <label for="phone">Phone Number</label
              ><input type="text" id="phone" name="phone" required />
            </div>
            <div class="form-group">
              <label for="email">Email</label
              ><input type="email" id="email" name="email" required />
            </div>
            <div class="form-group">
              <label for="gender">Gender</label>
              <select id="gender" name="gender" required>
                <option value="">Select Gender</option>
                <option value="MALE">Male</option>
                <option value="FEMALE">Female</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label for="role">Role</label>
              <select id="role" name="role" required>
                <option value="">Select Role</option>
                <option value="IT_OFFICER">IT Officer</option>
                <option value="BLOOD_DONATION_MANAGER">
                  Blood Donation Manager
                </option>
                <option value="HOSPITAL_COORDINATOR">
                  Hospital Coordinator
                </option>
                <option value="NURSE">Nurse</option>
                <option value="DONOR">Donor</option>
                <option value="EVENT_ORGANIZER">Event Organizer</option>
              </select>
            </div>
            <div class="form-group">
              <label for="password"
                >Password (leave blank to keep current)</label
              ><input
                type="password"
                id="password"
                name="password"
                minlength="6"
              />
            </div>
            <div class="form-group">
              <label for="passwordConfirm">Confirm Password</label
              ><input
                type="password"
                id="passwordConfirm"
                name="passwordConfirm"
              />
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-primary">Submit</button>
              <button type="button" class="btn-secondary" id="cancelBtn">
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
      <div class="modal-content notification-content">
        <div class="modal-body">
          <div class="notification success">
            <i class="fas fa-check-circle"></i>
            <p id="successMessage">Operation completed successfully!</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
      <div class="modal-content notification-content">
        <div class="modal-body">
          <div class="notification error">
            <i class="fas fa-exclamation-circle"></i>
            <p id="errorMessage">An error occurred!</p>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div class="container">
        <p>&copy; 2025 Blood Donation App. All rights reserved.</p>
      </div>
    </footer>

    <script>
      const API_BASE_URL = "/api/users";
      let currentUserRoles = [];

      document.addEventListener("DOMContentLoaded", function () {
        const jwtToken = localStorage.getItem("jwtToken");
        if (!jwtToken) {
          window.location.href = "/login";
          return;
        }

        try {
          currentUserRoles = JSON.parse(
            localStorage.getItem("userRoles") || "[]"
          );
        } catch (e) {
          console.error("Could not parse user roles from localStorage", e);
          currentUserRoles = [];
        }

        setupEventListeners();
        loadUsers();
        setupRoleBasedVisibility();
      });

      function openModal(modalId) {
        document.getElementById(modalId).style.display = "flex";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      function setupEventListeners() {
        document.getElementById("dob").addEventListener("change", function () {
          if (this.value) {
            const dob = new Date(this.value);
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
              age--;
            }
            document.getElementById("age").value = age;
          }
        });

        document.getElementById("addUserBtn").addEventListener("click", () => {
          document.getElementById("userForm").reset();
          document.getElementById("userId").value = "";
          document.getElementById("modalTitle").textContent = "Add New User";
          document.querySelector(
            '#userForm button[type="submit"]'
          ).textContent = "Add User";
          document
            .getElementById("password")
            .setAttribute("required", "required");
          document
            .getElementById("passwordConfirm")
            .setAttribute("required", "required");
          openModal("userModal");
        });

        document
          .getElementById("userForm")
          .addEventListener("submit", async function (event) {
            event.preventDefault();
            const password = document.getElementById("password").value;
            const passwordConfirm =
              document.getElementById("passwordConfirm").value;

            if (password !== passwordConfirm) {
              showErrorAlert("Passwords do not match.");
              return;
            }

            const formData = new FormData(this);
            const user = {};
            formData.forEach((value, key) => {
              if (value) user[key] = value;
            });

            if (user.age) user.age = parseInt(user.age, 10);
            if (user.userId) user.userId = parseInt(user.userId, 10);

            if (user.userId) {
              updateUser(user.userId, user);
            } else {
              addUser(user);
            }
          });

        document
          .getElementById("userTableBody")
          .addEventListener("click", function (event) {
            const editBtn = event.target.closest(".edit-btn");
            const deleteBtn = event.target.closest(".delete-btn");
            if (editBtn) {
              handleEditClick(editBtn);
            } else if (deleteBtn) {
              handleDeleteClick(deleteBtn);
            }
          });

        document
          .getElementById("cancelBtn")
          .addEventListener("click", () => closeModal("userModal"));
        document
          .querySelector("#userModal .close")
          .addEventListener("click", () => closeModal("userModal"));
      }

      async function fetchWithAuth(url, options = {}) {
        const jwtToken = localStorage.getItem("jwtToken");
        const headers = {
          Authorization: `Bearer ${jwtToken}`,
          "Content-Type": "application/json",
          ...options.headers,
        };
        const response = await fetch(url, { ...options, headers });
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({
            message: `HTTP error! Status: ${response.status}`,
          }));
          throw new Error(errorData.message);
        }
        // For DELETE requests with no content
        if (
          response.status === 204 ||
          response.headers.get("content-length") === "0"
        ) {
          return null;
        }
        return response.json();
      }

      async function loadUsers() {
        try {
          const users = await fetchWithAuth(API_BASE_URL);
          const userTableBody = document.getElementById("userTableBody");
          userTableBody.innerHTML = "";
          users.forEach((user) => {
            const row = userTableBody.insertRow();
            const userJsonString = JSON.stringify(user).replace(/'/g, "&apos;");
            row.innerHTML = `
                        <td>${user.userId}</td>
                        <td>${user.firstName}</td>
                        <td>${user.lastName}</td>
                        <td>${user.email}</td>
                        <td>${user.phone}</td>
                        <td>${user.role}</td>
                        <td class="actions-column" style="display: none;">
                            <button class="btn-info edit-btn" data-user='${userJsonString}'><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn-danger delete-btn" data-id="${user.userId}"><i class="fas fa-trash-alt"></i> Delete</button>
                        </td>
                    `;
          });
          setupRoleBasedVisibility();
        } catch (error) {
          showErrorAlert(`Failed to load users: ${error.message}`);
        }
      }

      async function addUser(user) {
        try {
          const responseData = await fetchWithAuth("/api/auth/signup", {
            method: "POST",
            body: JSON.stringify(user),
          });
          closeModal("userModal");
          showSuccessAlert(responseData.message || "User added successfully!");
          loadUsers();
        } catch (error) {
          showErrorAlert(`Failed to add user: ${error.message}`);
        }
      }

      async function updateUser(id, user) {
        try {
          await fetchWithAuth(`${API_BASE_URL}/${id}`, {
            method: "PUT",
            body: JSON.stringify(user),
          });
          closeModal("userModal");
          showSuccessAlert("User updated successfully!");
          loadUsers();
        } catch (error) {
          showErrorAlert(`Failed to update user: ${error.message}`);
        }
      }

      async function deleteUser(id) {
        if (confirm("Are you sure you want to delete this user?")) {
          try {
            await fetchWithAuth(`${API_BASE_URL}/${id}`, { method: "DELETE" });
            showSuccessAlert("User deleted successfully!");
            loadUsers();
          } catch (error) {
            showErrorAlert(`Failed to delete user: ${error.message}`);
          }
        }
      }

      function setupRoleBasedVisibility() {
        const canManage =
          currentUserRoles.includes("ROLE_IT_OFFICER") ||
          currentUserRoles.includes("ROLE_BLOOD_DONATION_MANAGER");
        const displayStyle = canManage ? "inline-flex" : "none";
        const tableCellStyle = canManage ? "flex" : "none";

        document.getElementById("addUserBtn").style.display = displayStyle;
        document.querySelector(".actions-header").style.display = canManage
          ? "table-cell"
          : "none";
        document.querySelectorAll(".actions-column").forEach((col) => {
          col.style.display = tableCellStyle;
        });
      }

      function handleEditClick(button) {
        const user = JSON.parse(button.dataset.user);

        document.getElementById("userId").value = user.userId;
        document.getElementById("firstName").value = user.firstName;
        document.getElementById("lastName").value = user.lastName;
        document.getElementById("dob").value = user.dob;
        document.getElementById("age").value = user.age;
        document.getElementById("nic").value = user.nic;
        document.getElementById("phone").value = user.phone;
        document.getElementById("email").value = user.email;
        document.getElementById("gender").value = user.gender;
        document.getElementById("role").value = user.role;
        document.getElementById("password").value = "";
        document.getElementById("passwordConfirm").value = "";

        document.getElementById("password").removeAttribute("required");
        document.getElementById("passwordConfirm").removeAttribute("required");

        document.getElementById("modalTitle").textContent = "Edit User";
        document.querySelector('#userForm button[type="submit"]').textContent =
          "Update User";
        openModal("userModal");
      }

      function handleDeleteClick(button) {
        const id = button.dataset.id;
        deleteUser(id);
      }

      function showSuccessAlert(message) {
        document.getElementById("successMessage").textContent = message;
        openModal("successModal");
        setTimeout(() => closeModal("successModal"), 3000);
      }

      function showErrorAlert(message) {
        document.getElementById("errorMessage").textContent = message;
        openModal("errorModal");
        setTimeout(() => closeModal("errorModal"), 5000);
      }
    </script>
  </body>
</html>
>>>>>>> Stashed changes
