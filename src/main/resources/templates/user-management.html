<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Management</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
  </head>
  <body>
    <header>
      <div class="container">
        <div class="logo-container">
          <i class="fas fa-heartbeat"></i>
          <h1>Blood Donation Management</h1>
        </div>
        <nav>
          <ul>
            <li>
              <a href="/"><i class="fas fa-home"></i> Home</a>
            </li>
            <li>
              <a href="/login"><i class="fas fa-sign-in-alt"></i> Login</a>
            </li>
            <li>
              <a href="/register"><i class="fas fa-user-plus"></i> Sign Up</a>
            </li>
            <li>
              <a href="/donor-signup"
                ><i class="fas fa-tint"></i> Donor Sign Up</a
              >
            </li>
            <li>
              <a href="/dashboard"
                ><i class="fas fa-tachometer-alt"></i> Dashboard</a
              >
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <main>
      <div class="container">
        <div class="page-header">
          <h2>User Management</h2>
          <button id="addUserBtn" class="btn-primary" style="display: none">
            <i class="fas fa-plus-circle"></i> Add New User
          </button>
        </div>

        <!-- User List -->
        <div class="table-container">
          <h3>All Users</h3>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Role</th>
                  <th class="actions-header" style="display: none">Actions</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <!-- User rows will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- User Form Modal -->
    <div id="userModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">Add New User</h3>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <form id="userForm">
            <input type="hidden" id="userId" name="userId" />
            <div class="form-group">
              <label for="firstName">First Name</label
              ><input type="text" id="firstName" name="firstName" required />
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label
              ><input type="text" id="lastName" name="lastName" required />
            </div>
            <div class="form-group">
              <label for="dob">Date of Birth</label
              ><input type="date" id="dob" name="dob" required />
            </div>
            <div class="form-group">
              <label for="age">Age</label
              ><input type="number" id="age" name="age" readonly />
            </div>
            <div class="form-group">
              <label for="nic">NIC</label
              ><input type="text" id="nic" name="nic" required minlength="10" />
            </div>
            <div class="form-group">
              <label for="phone">Phone Number</label
              ><input type="text" id="phone" name="phone" required />
            </div>
            <div class="form-group">
              <label for="email">Email</label
              ><input type="email" id="email" name="email" required />
            </div>
            <div class="form-group">
              <label for="gender">Gender</label>
              <select id="gender" name="gender" required>
                <option value="">Select Gender</option>
                <option value="MALE">Male</option>
                <option value="FEMALE">Female</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label for="role">Role</label>
              <select id="role" name="role" required>
                <option value="">Select Role</option>
                <option value="IT_OFFICER">IT Officer</option>
                <option value="BLOOD_DONATION_MANAGER">
                  Blood Donation Manager
                </option>
                <option value="HOSPITAL_COORDINATOR">
                  Hospital Coordinator
                </option>
                <option value="NURSE">Nurse</option>
                <option value="DONOR">Donor</option>
                <option value="EVENT_ORGANIZER">Event Organizer</option>
              </select>
            </div>
            <div class="form-group">
              <label for="password"
                >Password (leave blank to keep current)</label
              ><input
                type="password"
                id="password"
                name="password"
                minlength="6"
              />
            </div>
            <div class="form-group">
              <label for="confirmPassword">Confirm Password</label
              ><input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
              />
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-primary">Submit</button>
              <button type="button" class="btn-secondary" id="cancelBtn">
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
      <div class="modal-content notification-content">
        <div class="modal-body">
          <div class="notification success">
            <i class="fas fa-check-circle"></i>
            <p id="successMessage">Operation completed successfully!</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
      <div class="modal-content notification-content">
        <div class="modal-body">
          <div class="notification error">
            <i class="fas fa-exclamation-circle"></i>
            <p id="errorMessage">An error occurred!</p>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div class="container">
        <p>&copy; 2025 Blood Donation App. All rights reserved.</p>
      </div>
    </footer>

    <script>
      const API_BASE_URL = "/api/users";
      let currentUserRoles = [];

      document.addEventListener("DOMContentLoaded", function () {
        const jwtToken = localStorage.getItem("jwtToken");
        if (!jwtToken) {
          window.location.href = "/login";
          return;
        }

        try {
          currentUserRoles = JSON.parse(
            localStorage.getItem("userRoles") || "[]"
          );
        } catch (e) {
          console.error("Could not parse user roles from localStorage", e);
          currentUserRoles = [];
        }

        setupEventListeners();
        loadUsers();
        setupRoleBasedVisibility();
      });

      function openModal(modalId) {
        document.getElementById(modalId).style.display = "flex";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      function setupEventListeners() {
        document.getElementById("dob").addEventListener("change", function () {
          if (this.value) {
            const dob = new Date(this.value);
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
              age--;
            }
            document.getElementById("age").value = age;
          }
        });

        document.getElementById("addUserBtn").addEventListener("click", () => {
          document.getElementById("userForm").reset();
          document.getElementById("userId").value = "";
          document.getElementById("modalTitle").textContent = "Add New User";
          document.querySelector(
            '#userForm button[type="submit"]'
          ).textContent = "Add User";
          document
            .getElementById("password")
            .setAttribute("required", "required");
          document
            .getElementById("confirmPassword")
            .setAttribute("required", "required");
          openModal("userModal");
        });

        document
          .getElementById("userForm")
          .addEventListener("submit", async function (event) {
            event.preventDefault();
            const password = document.getElementById("password").value;
            const confirmPassword =
              document.getElementById("confirmPassword").value;

            if (password !== confirmPassword) {
              showErrorAlert("Passwords do not match.");
              return;
            }

            const formData = new FormData(this);
            const user = {};
            formData.forEach((value, key) => {
              if (key !== "confirmPassword") {
                if (value) user[key] = value;
              }
            });

            if (user.age) user.age = parseInt(user.age, 10);
            if (user.userId) user.userId = parseInt(user.userId, 10);

            if (user.userId) {
              updateUser(user.userId, user);
            } else {
              addUser(user);
            }
          });

        document
          .getElementById("userTableBody")
          .addEventListener("click", function (event) {
            const editBtn = event.target.closest(".edit-btn");
            const deleteBtn = event.target.closest(".delete-btn");
            if (editBtn) {
              handleEditClick(editBtn);
            } else if (deleteBtn) {
              handleDeleteClick(deleteBtn);
            }
          });

        document
          .getElementById("cancelBtn")
          .addEventListener("click", () => closeModal("userModal"));
        document
          .querySelector("#userModal .close")
          .addEventListener("click", () => closeModal("userModal"));
      }

      async function fetchWithAuth(url, options = {}) {
        const jwtToken = localStorage.getItem("jwtToken");
        const headers = {
          Authorization: `Bearer ${jwtToken}`,
          "Content-Type": "application/json",
          ...options.headers,
        };
        const response = await fetch(url, { ...options, headers });
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({
            message: `HTTP error! Status: ${response.status}`,
          }));
          throw new Error(errorData.message);
        }
        // For DELETE requests with no content
        if (
          response.status === 204 ||
          response.headers.get("content-length") === "0"
        ) {
          return null;
        }
        return response.json();
      }

      async function loadUsers() {
        try {
          const users = await fetchWithAuth(API_BASE_URL);
          const userTableBody = document.getElementById("userTableBody");
          userTableBody.innerHTML = "";
          users.forEach((user) => {
            const row = userTableBody.insertRow();
            const userJsonString = JSON.stringify(user).replace(/'/g, "&apos;");
            row.innerHTML = `
                        <td>${user.userId}</td>
                        <td>${user.firstName}</td>
                        <td>${user.lastName}</td>
                        <td>${user.email}</td>
                        <td>${user.phone}</td>
                        <td>${user.role}</td>
                        <td class="actions-column" style="display: none;">
                            <button class="btn-info edit-btn" data-user='${userJsonString}'><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn-danger delete-btn" data-id="${user.userId}"><i class="fas fa-trash-alt"></i> Delete</button>
                        </td>
                    `;
          });
          setupRoleBasedVisibility();
        } catch (error) {
          showErrorAlert(`Failed to load users: ${error.message}`);
        }
      }

      async function addUser(user) {
        try {
          await fetchWithAuth("/api/auth/signup", {
            method: "POST",
            body: JSON.stringify(user),
          });
          closeModal("userModal");
          showSuccessAlert("User added successfully!");
          loadUsers();
        } catch (error) {
          showErrorAlert(`Failed to add user: ${error.message}`);
        }
      }

      async function updateUser(id, user) {
        try {
          await fetchWithAuth(`${API_BASE_URL}/${id}`, {
            method: "PUT",
            body: JSON.stringify(user),
          });
          closeModal("userModal");
          showSuccessAlert("User updated successfully!");
          loadUsers();
        } catch (error) {
          showErrorAlert(`Failed to update user: ${error.message}`);
        }
      }

      async function deleteUser(id) {
        if (confirm("Are you sure you want to delete this user?")) {
          try {
            await fetchWithAuth(`${API_BASE_URL}/${id}`, { method: "DELETE" });
            showSuccessAlert("User deleted successfully!");
            loadUsers();
          } catch (error) {
            showErrorAlert(`Failed to delete user: ${error.message}`);
          }
        }
      }

      function setupRoleBasedVisibility() {
        const canManage =
          currentUserRoles.includes("ROLE_IT_OFFICER") ||
          currentUserRoles.includes("ROLE_BLOOD_DONATION_MANAGER");
        const displayStyle = canManage ? "inline-flex" : "none";
        const tableCellStyle = canManage ? "flex" : "none";

        document.getElementById("addUserBtn").style.display = displayStyle;
        document.querySelector(".actions-header").style.display = canManage
          ? "table-cell"
          : "none";
        document.querySelectorAll(".actions-column").forEach((col) => {
          col.style.display = tableCellStyle;
        });
      }

      function handleEditClick(button) {
        const user = JSON.parse(button.dataset.user);

        document.getElementById("userId").value = user.userId;
        document.getElementById("firstName").value = user.firstName;
        document.getElementById("lastName").value = user.lastName;
        document.getElementById("dob").value = user.dob;
        document.getElementById("age").value = user.age;
        document.getElementById("nic").value = user.nic;
        document.getElementById("phone").value = user.phone;
        document.getElementById("email").value = user.email;
        document.getElementById("gender").value = user.gender;
        document.getElementById("role").value = user.role;
        document.getElementById("password").value = "";
        document.getElementById("confirmPassword").value = "";

        document.getElementById("password").removeAttribute("required");
        document.getElementById("confirmPassword").removeAttribute("required");

        document.getElementById("modalTitle").textContent = "Edit User";
        document.querySelector('#userForm button[type="submit"]').textContent =
          "Update User";
        openModal("userModal");
      }

      function handleDeleteClick(button) {
        const id = button.dataset.id;
        deleteUser(id);
      }

      function showSuccessAlert(message) {
        document.getElementById("successMessage").textContent = message;
        openModal("successModal");
        setTimeout(() => closeModal("successModal"), 3000);
      }

      function showErrorAlert(message) {
        document.getElementById("errorMessage").textContent = message;
        openModal("errorModal");
        setTimeout(() => closeModal("errorModal"), 5000);
      }
    </script>
  </body>
</html>
