<!-- event-management.html -->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Management - Blood Donation System</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
  </head>
  <body>
    <header>
      <div class="container">
        <div class="logo-container">
          <i class="fas fa-heartbeat"></i>
          <h1>Blood Donation Management</h1>
        </div>
        <nav>
          <ul>
            <li>
              <a href="/"><i class="fas fa-home"></i> Home</a>
            </li>
            <li>
              <a href="/login"><i class="fas fa-sign-in-alt"></i> Login</a>
            </li>
            <li>
              <a href="/register"><i class="fas fa-user-plus"></i> Sign Up</a>
            </li>
            <li>
              <a href="/donor-signup"
                ><i class="fas fa-tint"></i> Donor Sign Up</a
              >
            </li>
            <li>
              <a href="/dashboard"
                ><i class="fas fa-tachometer-alt"></i> Dashboard</a
              >
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <main>
      <div class="container">
        <div class="page-header">
          <h2>Event Management</h2>
          <button id="addEventBtn" class="btn-primary">
            <i class="fas fa-plus-circle"></i> Add New Event
          </button>
        </div>

        <!-- Event List -->
        <div class="table-container">
          <h3>All Events</h3>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Date</th>
                  <th>Location</th>
                  <th>Description</th>
                  <th>Organizer</th>
                  <th class="actions-column">Actions</th>
                </tr>
              </thead>
              <tbody id="eventTableBody">
                <!-- Event rows will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <div class="container">
        <p>&copy; 2025 Blood Donation App. All rights reserved.</p>
      </div>
    </footer>

    <!-- Event Form Modal -->
    <div id="eventModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">Add New Event</h3>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <form id="eventForm">
            <input type="hidden" id="eventId" name="eventId" />
            <div class="form-group">
              <label for="eventName">Event Name</label>
              <input type="text" id="eventName" name="eventName" required />
            </div>
            <div class="form-group">
              <label for="eventDate">Event Date</label>
              <input type="date" id="eventDate" name="eventDate" required />
            </div>
            <div class="form-group">
              <label for="location">Location</label>
              <input type="text" id="location" name="location" required />
            </div>
            <div class="form-group">
              <label for="description">Description</label>
              <textarea id="description" name="description" rows="3"></textarea>
            </div>
            <input
              type="hidden"
              id="eventOrganizerId"
              name="eventOrganizerId"
            />
            <div class="form-actions">
              <button type="submit" class="btn-primary">Submit Event</button>
              <button type="button" class="btn-secondary" id="cancelEdit">
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
      <div class="modal-content success-content">
        <div class="modal-header">
          <h3>Success</h3>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <div class="notification success">
            <i class="fas fa-check-circle"></i>
            <p id="successMessage">Operation completed successfully!</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
      <div class="modal-content error-content">
        <div class="modal-header">
          <h3>Error</h3>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <div class="notification error">
            <i class="fas fa-exclamation-circle"></i>
            <p id="errorMessage">An error occurred!</p>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
      const API_BASE_URL = "/api/events";
      let currentUserRoles = [];
      let currentUserId = null;

      document.addEventListener("DOMContentLoaded", function () {
        const jwtToken = localStorage.getItem("jwtToken");
        if (!jwtToken) {
          window.location.href = "/login";
          return;
        }

        const userRoles = localStorage.getItem("userRoles");
        if (userRoles) {
          currentUserRoles = JSON.parse(userRoles);
        }
        currentUserId = localStorage.getItem("userId");

        loadEvents();
        setupRoleBasedVisibility();

        // Modal event listeners
        document
          .getElementById("addEventBtn")
          .addEventListener("click", function () {
            openModal("eventModal");
            resetForm();
          });

        document
          .getElementById("eventForm")
          .addEventListener("submit", async function (event) {
            event.preventDefault();
            const eventId = document.getElementById("eventId").value;
            const formData = new FormData(this);
            const eventData = {};

            for (let [key, value] of formData.entries()) {
              eventData[key] = value;
            }

            if (eventId) {
              eventData.eventId = parseInt(eventId, 10);
            } else {
              delete eventData.eventId;
            }

            if (hasRole("ROLE_EVENT_ORGANIZER") && currentUserId) {
              eventData.eventOrganizerId = parseInt(currentUserId, 10);
            } else {
              delete eventData.eventOrganizerId;
            }

            if (eventId) {
              updateEvent(eventId, eventData);
            } else {
              createEvent(eventData);
            }
          });

        document
          .getElementById("cancelEdit")
          .addEventListener("click", function () {
            closeModal("eventModal");
            resetForm();
          });

        // Close modals when clicking on X
        document.querySelectorAll(".close").forEach((closeBtn) => {
          closeBtn.addEventListener("click", function () {
            const modalId = this.closest(".modal").id;
            closeModal(modalId);
          });
        });

        // Close modals when clicking outside
        window.addEventListener("click", function (event) {
          if (event.target.classList.contains("modal")) {
            closeModal(event.target.id);
          }
        });
      });

      function openModal(modalId) {
        document.getElementById(modalId).style.display = "block";
        document.body.style.overflow = "hidden";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
        document.body.style.overflow = "auto";
      }

      function hasRole(roleName) {
        return currentUserRoles.some(
          (role) =>
            (typeof role === "string" && role === roleName) ||
            (typeof role === "object" && role.authority === roleName)
        );
      }

      function setupRoleBasedVisibility() {
        const addEventBtn = document.getElementById("addEventBtn");
        if (hasRole("ROLE_EVENT_ORGANIZER")) {
          addEventBtn.style.display = "inline-flex";
        } else {
          addEventBtn.style.display = "none";
        }
      }

      async function loadEvents() {
        try {
          let url = API_BASE_URL;
          if (hasRole("ROLE_EVENT_ORGANIZER")) {
            url = `${API_BASE_URL}/organizer/${currentUserId}`;
          }

          const response = await fetch(url, {
            method: "GET",
            headers: {
              Authorization: "Bearer " + localStorage.getItem("jwtToken"),
            },
          });

          if (response.ok) {
            const events = await response.json();
            const tableBody = document.getElementById("eventTableBody");
            tableBody.innerHTML = "";
            events.forEach((event) => {
              const row = tableBody.insertRow();
              
              // Determine which buttons to show based on roles
              const showEditButton = hasRole("ROLE_EVENT_ORGANIZER");
              const showDeleteButton = hasRole("ROLE_EVENT_ORGANIZER") || hasRole("ROLE_BLOOD_DONATION_MANAGER");
              
              row.innerHTML = `
                <td>${event.eventId}</td>
                <td>${event.eventName}</td>
                <td>${formatDate(event.eventDate)}</td>
                <td>${event.location}</td>
                <td>${event.description || "N/A"}</td>
                <td>${
                  event.eventOrganizer
                    ? event.eventOrganizer.firstName +
                      " " +
                      event.eventOrganizer.lastName
                    : "N/A"
                }</td>
                <td class="actions-column">
                  ${
                    showEditButton
                      ? `
                        <button class="btn-info edit-btn" data-id="${
                          event.eventId
                        }" data-event='${JSON.stringify(event)}'>
                          <i class="fas fa-edit"></i> Edit
                        </button>
                      `
                      : ""
                  }
                  ${
                    showDeleteButton
                      ? `
                        <button class="btn-danger delete-btn" data-id="${
                          event.eventId
                        }">
                          <i class="fas fa-trash-alt"></i> Delete
                        </button>
                      `
                      : ""
                  }
                </td>
              `;
            });
            attachEventListeners();
          } else {
            const errorData = await response.json();
            showErrorAlert(
              "Failed to load events: " +
                (errorData.message || response.statusText)
            );
          }
        } catch (error) {
          showErrorAlert("An unexpected error occurred while loading events.");
          console.error("Error loading events:", error);
        }
      }

      async function createEvent(eventData) {
        try {
          const response = await fetch(API_BASE_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("jwtToken"),
            },
            body: JSON.stringify(eventData),
          });

          if (response.ok) {
            closeModal("eventModal");
            showSuccessAlert("Event added successfully!");
            resetForm();
            loadEvents();
          } else {
            let errorMessage = "Failed to add event.";
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
              const errorData = await response.json();
              errorMessage += " " + (errorData.message || response.statusText);
            } else {
              if (response.status === 403) {
                errorMessage +=
                  " You do not have permission to create events. Please ensure you are logged in as an Event Organizer.";
              } else {
                errorMessage +=
                  " Server responded with status: " +
                  response.status +
                  " " +
                  response.statusText;
              }
            }
            showErrorAlert(errorMessage);
          }
        } catch (error) {
          showErrorAlert("An unexpected error occurred while adding event.");
          console.error("Error adding event:", error);
        }
      }

      async function updateEvent(id, eventData) {
        try {
          const response = await fetch(`${API_BASE_URL}/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("jwtToken"),
            },
            body: JSON.stringify(eventData),
          });

          if (response.ok) {
            closeModal("eventModal");
            showSuccessAlert("Event updated successfully!");
            resetForm();
            loadEvents();
          } else {
            const errorData = await response.json();
            showErrorAlert(
              "Failed to update event: " +
                (errorData.message || response.statusText)
            );
          }
        } catch (error) {
          showErrorAlert("An unexpected error occurred while updating event.");
          console.error("Error updating event:", error);
        }
      }

      async function deleteEvent(id) {
        if (confirm("Are you sure you want to delete this event?")) {
          try {
            const response = await fetch(`${API_BASE_URL}/${id}`, {
              method: "DELETE",
              headers: {
                Authorization: "Bearer " + localStorage.getItem("jwtToken"),
              },
            });

            if (response.ok) {
              showSuccessAlert("Event deleted successfully!");
              loadEvents();
            } else {
              const errorData = await response.json();
              showErrorAlert(
                "Failed to delete event: " +
                  (errorData.message || response.statusText)
              );
            }
          } catch (error) {
            showErrorAlert(
              "An unexpected error occurred while deleting event."
            );
            console.error("Error deleting event:", error);
          }
        }
      }

      function attachEventListeners() {
        document.querySelectorAll(".edit-btn").forEach((button) => {
          button.removeEventListener("click", handleEditClick);
          button.addEventListener("click", handleEditClick);
        });

        document.querySelectorAll(".delete-btn").forEach((button) => {
          button.removeEventListener("click", handleDeleteClick);
          button.addEventListener("click", handleDeleteClick);
        });
      }

      function handleEditClick(event) {
        const eventData = JSON.parse(
          event.target.closest(".edit-btn").dataset.event
        );
        document.getElementById("eventId").value = eventData.eventId;
        document.getElementById("eventName").value = eventData.eventName;
        document.getElementById("eventDate").value = eventData.eventDate;
        document.getElementById("location").value = eventData.location;
        document.getElementById("description").value = eventData.description;

        document.getElementById("modalTitle").textContent = "Edit Event";
        document.querySelector('#eventForm button[type="submit"]').textContent =
          "Update Event";
        openModal("eventModal");
      }

      function handleDeleteClick(event) {
        const id = event.target.closest(".delete-btn").dataset.id;
        deleteEvent(id);
      }

      function resetForm() {
        document.getElementById("eventForm").reset();
        document.getElementById("eventId").value = "";
        document.getElementById("modalTitle").textContent = "Add New Event";
        document.querySelector('#eventForm button[type="submit"]').textContent =
          "Submit Event";

        if (hasRole("ROLE_EVENT_ORGANIZER") && currentUserId) {
          document.getElementById("eventOrganizerId").value = currentUserId;
        }
      }

      function showSuccessAlert(message) {
        document.getElementById("successMessage").textContent = message;
        openModal("successModal");
        setTimeout(() => {
          closeModal("successModal");
        }, 3000);
      }

      function showErrorAlert(message) {
        document.getElementById("errorMessage").textContent = message;
        openModal("errorModal");
        setTimeout(() => {
          closeModal("errorModal");
        }, 5000);
      }

      function formatDate(dateString) {
        const options = { year: "numeric", month: "long", day: "numeric" };
        return new Date(dateString).toLocaleDateString(undefined, options);
      }
    </script>
  </body>
</html>